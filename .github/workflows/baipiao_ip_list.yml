name: æ›´æ–°ç™½å«–IPåº“
on:
  workflow_dispatch:
  schedule:
    - cron: '30 21 * * *'  # æ¯å¤©çš„8ç‚¹ã€16ç‚¹æ‰§è¡Œï¼ˆUTCæ—¶é—´ï¼‰

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      # å…¨å±€å®šä¹‰å˜é‡ï¼Œæ‰€æœ‰æ­¥éª¤å…±äº«
      PROXYIP_URL: ${{ vars.PROXYIP_URL }}
      
    steps:
      - name: æ£€å‡ºä»£ç ä»“åº“
        uses: actions/checkout@v4
        with:
          # åŠ¨æ€è·å–å½“å‰åˆ†æ”¯
          ref: ${{ github.ref }}
          
      - name: Check PROXYIP_URL variable
        run: |
          if [ -z "$PROXYIP_URL" ]; then
            echo "âŒ é”™è¯¯: æœªè®¾ç½® PROXYIP_URL å˜é‡"
            echo "è¯·åœ¨ä»“åº“è®¾ç½®ä¸­æ·»åŠ  PROXYIP_URL å˜é‡ï¼š"
            echo "1. è¿›å…¥ä»“åº“ Settings > Secrets and variables > Actions"
            echo "2. åœ¨ Variables æ ‡ç­¾é¡µä¸­æ·»åŠ æ–°å˜é‡"
            echo "3. Name: PROXYIP_URL"
            echo "4. Value: é…ç½®æ–‡ä»¶çš„URLåœ°å€"
            exit 1
          fi
          echo "âœ… PROXYIP_URL å˜é‡å·²è®¾ç½®: $PROXYIP_URL"
          
      - name: Check URL status
        id: check_url
        run: |
          # å¢å¼ºé”™è¯¯å¤„ç†ï¼Œæ•è·curlå¤±è´¥
          STATUS_CODE=$(curl -s -o /dev/null -w "%{http_code}" "$PROXYIP_URL" 2>/dev/null || echo "CURL_FAIL")
          
          if [[ "$STATUS_CODE" =~ ^[0-9]+$ ]]; then
            echo "Status code: $STATUS_CODE"
            if [ "$STATUS_CODE" == "200" ]; then
              echo "âœ… URL å“åº”æ­£å¸¸ï¼ŒçŠ¶æ€ç ä¸º 200"
              echo "url_status_ok=true" >> $GITHUB_OUTPUT
            else
              echo "âš ï¸ URL å“åº”å¼‚å¸¸ï¼ŒçŠ¶æ€ç ä¸º $STATUS_CODE"
              echo "url_status_ok=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "âŒ CURL é”™è¯¯: æ— æ³•è®¿é—® URL (é”™è¯¯ç±»å‹: $STATUS_CODE)"
            echo "url_status_ok=false" >> $GITHUB_OUTPUT
          fi
          
      - name: Download
        if: steps.check_url.outputs.url_status_ok == 'true'
        run: |
          # å¢åŠ é‡è¯•æœºåˆ¶
          for i in {1..3}; do
            if curl -L -f -o baipiao.txt "$PROXYIP_URL"; then
              echo "âœ… æ–‡ä»¶ä¸‹è½½æˆåŠŸ"
              break
            else
              echo "âš ï¸ ä¸‹è½½å¤±è´¥ï¼Œå°è¯• $i/3"
              sleep 2
            fi
          done
          
          # æœ€ç»ˆæ£€æŸ¥æ–‡ä»¶æ˜¯å¦æœ‰æ•ˆ
          if [ ! -f baipiao.txt ] || [ ! -s baipiao.txt ]; then
            echo "âŒ é”™è¯¯: baipiao.txt æ–‡ä»¶æ— æ•ˆ"
            exit 1
          fi
          
      - name: æäº¤æ›´æ–°çš„IPåº“æ–‡ä»¶
        if: steps.check_url.outputs.url_status_ok == 'true'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          # æ£€æŸ¥æ–‡ä»¶å˜åŒ–
          if git diff --exit-code --quiet baipiao.txt; then
            echo "â„¹ï¸ baipiao.txt æ–‡ä»¶æ²¡æœ‰å˜åŒ–ï¼Œè·³è¿‡æäº¤"
          else
            echo "âœ… æ£€æµ‹åˆ° baipiao.txt æ–‡ä»¶æœ‰å˜åŒ–ï¼Œå¼€å§‹æäº¤"
            git add baipiao.txt
            git commit -m "æ›´æ–°IPåº“æ–‡ä»¶ $(date +'%Y-%m-%d %H:%M:%S')"
            
            # åŠ¨æ€è·å–å½“å‰åˆ†æ”¯
            CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)
            
            # æ¨é€æ—¶ä½¿ç”¨ -u é€‰é¡¹è®¾ç½®ä¸Šæ¸¸åˆ†æ”¯
            git push -u origin HEAD:$CURRENT_BRANCH
            echo "ğŸš€ æäº¤å®Œæˆï¼Œå·²æ¨é€åˆ° $CURRENT_BRANCH åˆ†æ”¯"
          fi
